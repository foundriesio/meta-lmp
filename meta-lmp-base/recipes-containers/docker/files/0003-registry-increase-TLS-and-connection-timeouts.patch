From c12f9487ff2edd2f98b85f4328649c2d6a16212a Mon Sep 17 00:00:00 2001
From: Mike Sul <mike.sul@foundries.io>
Date: Wed, 30 Jun 2021 15:06:05 +0300
Subject: [PATCH 3/5] registry: increase TLS and connection timeouts

Upstream-Status: Pending

Signed-off-by: Mike Sul <mike.sul@foundries.io>
Signed-off-by: Jose Quaresma <jose.quaresma@foundries.io>
---
 distribution/registry.go | 4 ++--
 registry/auth.go         | 4 ++--
 registry/registry.go     | 4 ++--
 3 files changed, 6 insertions(+), 6 deletions(-)

diff --git a/distribution/registry.go b/distribution/registry.go
index ef75136bdc..315ebd9d01 100644
--- a/distribution/registry.go
+++ b/distribution/registry.go
@@ -79,7 +79,7 @@ func newRepository(
 	repoName := reference.Path(ref)
 
 	direct := &net.Dialer{
-		Timeout:   30 * time.Second,
+		Timeout:   60 * time.Second,
 		KeepAlive: 30 * time.Second,
 	}
 
@@ -87,7 +87,7 @@ func newRepository(
 	base := &http.Transport{
 		Proxy:               http.ProxyFromEnvironment,
 		DialContext:         direct.DialContext,
-		TLSHandshakeTimeout: 10 * time.Second,
+		TLSHandshakeTimeout: 60 * time.Second,
 		TLSClientConfig:     endpoint.TLSConfig,
 		// TODO(dmcgowan): Call close idle connections when complete and use keep alive
 		DisableKeepAlives: true,
diff --git a/registry/auth.go b/registry/auth.go
index 1b0eeeed0b..e2a707eaf5 100644
--- a/registry/auth.go
+++ b/registry/auth.go
@@ -123,7 +123,7 @@ func v2AuthHTTPClient(endpoint *url.URL, authTransport http.RoundTripper, modifi
 
 	return &http.Client{
 		Transport: transport.NewTransport(authTransport, modifiers...),
-		Timeout:   15 * time.Second,
+		Timeout:   60 * time.Second,
 	}, nil
 }
 
@@ -178,7 +178,7 @@ func (err PingResponseError) Error() string {
 func PingV2Registry(endpoint *url.URL, transport http.RoundTripper) (challenge.Manager, error) {
 	pingClient := &http.Client{
 		Transport: transport,
-		Timeout:   15 * time.Second,
+		Timeout:   60 * time.Second,
 	}
 	endpointStr := strings.TrimRight(endpoint.String(), "/") + "/v2/"
 	req, err := http.NewRequest(http.MethodGet, endpointStr, http.NoBody)
diff --git a/registry/registry.go b/registry/registry.go
index d3b3fbc9ba..f581913686 100644
--- a/registry/registry.go
+++ b/registry/registry.go
@@ -142,10 +142,10 @@ func newTransport(tlsConfig *tls.Config) http.RoundTripper {
 		&http.Transport{
 			Proxy: http.ProxyFromEnvironment,
 			DialContext: (&net.Dialer{
-				Timeout:   30 * time.Second,
+				Timeout:   60 * time.Second,
 				KeepAlive: 30 * time.Second,
 			}).DialContext,
-			TLSHandshakeTimeout: 10 * time.Second,
+			TLSHandshakeTimeout: 60 * time.Second,
 			TLSClientConfig:     tlsConfig,
 			// TODO(dmcgowan): Call close idle connections when complete and use keep alive
 			DisableKeepAlives: true,
-- 
2.50.1

