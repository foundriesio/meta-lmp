From 096f01b0496fdbccea611d9ad8ac38a9f389afad Mon Sep 17 00:00:00 2001
From: Mike Sul <mike.sul@foundries.io>
Date: Tue, 14 Feb 2023 12:22:15 +0000
Subject: [PATCH 5/5] Fsync layer once extracted to file system

- Sync an overall file system just after layer unpack while the control
  flow is within the layer "change root".

Signed-off-by: Mike <mike.sul@foundries.io>
Signed-off-by: Jose Quaresma <jose.quaresma@foundries.io>
---
 pkg/chrootarchive/diff_unix.go | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/pkg/chrootarchive/diff_unix.go b/pkg/chrootarchive/diff_unix.go
index fcc02f675e..7a8fd200ec 100644
--- a/pkg/chrootarchive/diff_unix.go
+++ b/pkg/chrootarchive/diff_unix.go
@@ -12,6 +12,7 @@ import (
 	"os"
 	"path/filepath"
 	"runtime"
+	"syscall"
 
 	"github.com/containerd/containerd/pkg/userns"
 	"github.com/docker/docker/pkg/archive"
@@ -73,6 +74,8 @@ func applyLayer() {
 		fatal(err)
 	}
 
+	syscall.Sync()
+
 	os.Exit(0)
 }
 
-- 
2.34.1

