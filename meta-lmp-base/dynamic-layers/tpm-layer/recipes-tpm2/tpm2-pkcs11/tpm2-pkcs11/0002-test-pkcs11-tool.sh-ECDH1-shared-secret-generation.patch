From d0c07ea1f8172d706eee1f36f8c3ca88d7cb48eb Mon Sep 17 00:00:00 2001
From: Jorge Ramirez-Ortiz <jorge@foundries.io>
Date: Thu, 16 Feb 2023 17:45:31 +0100
Subject: [PATCH] test/pkcs11-tool.sh: ECDH1, shared secret generation

Validate ECDH1 shared secret generation.

Upstream-Status: Backport [https://github.com/tpm2-software/tpm2-pkcs11/commit/c616c6c47824a3e01e42f3e216c12b0c8c384e83]

Signed-off-by: Jorge Ramirez-Ortiz <jorge@foundries.io>
Signed-off-by: Jose Quaresma <jose.quaresma@foundries.io>
---
 test/integration/pkcs11-tool.sh | 33 +++++++++++++++++++++++++++++++++
 1 file changed, 33 insertions(+)

diff --git a/test/integration/pkcs11-tool.sh b/test/integration/pkcs11-tool.sh
index ae49371..b5919fd 100755
--- a/test/integration/pkcs11-tool.sh
+++ b/test/integration/pkcs11-tool.sh
@@ -73,6 +73,39 @@ echo "Deleting pubkey"
 pkcs11_tool --slot=1 --pin=myuserpin --login --delete-object --type=pubkey --label=myecckey
 echo "Pubkey deleted"
 
+# test ECHD1 derive
+echo "Test ECDH1-DERIVE"
+echo "Create EC keys"
+tmp=$TPM2_PKCS11_STORE
+pkcs11_tool --slot=1 --keypairgen --login --pin myuserpin \
+            --key-type EC:prime256v1 --id 01 --label key1
+
+pkcs11_tool --slot=1 --keypairgen --login --pin myuserpin \
+            --key-type EC:prime256v1 --id 02 --label key2
+
+echo "Read public components"
+if pkcs11_tool --read-object --login --pin myuserpin --type pubkey -id 01 -o {tmp}/key1_pub.der ; then
+    pkcs11_tool --read-object --login --pin myuserpin --type pubkey --id 02 -o {tmp}/key2_pub.der
+
+    echo "Derive secrets"
+    pkcs11_tool  --derive -m ECDH1-DERIVE --id 01 --label key1 \
+                 --login --pin myuserpin \
+                 --input-file {tmp}/key2_pub.der \
+                 --output-file {tmp}/shared_secret_1
+
+    pkcs11_tool  --derive -m ECDH1-DERIVE --id 02 --label key2 \
+                 --login --pin myuserpin \
+                 --input-file {tmp}/key1_pub.der \
+                 --output-file {tmp}/shared_secret_2
+
+    echo "Validate output"
+    diff {tmp}/shared_secret_2 {tmp}/shared_secret_1 > /dev/null 2>&1
+    test "$?" -eq "0"
+else
+    echo "pkcs11-tool can't read EC key public components"
+    echo "Skipp ECDH1-1 derive test"
+fi
+
 # Verify we can add a certificate, since this is a setup a test, the store should contain a cert to use.
 echo "Writing certificate"
 # Not all versions of pkcs11-tool handle PEM to DER conversions, 0.15 doesn't, 0.19 does. So always
