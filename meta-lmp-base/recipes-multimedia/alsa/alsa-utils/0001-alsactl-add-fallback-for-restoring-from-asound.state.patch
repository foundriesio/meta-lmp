From 6bf5c56e692b66ce1e4705c15adc1ae9815dfccb Mon Sep 17 00:00:00 2001
From: Oleksandr Suvorov <oleksandr.suvorov@foundries.io>
Date: Thu, 23 Mar 2023 22:03:14 +0200
Subject: [PATCH] alsactl: add fallback for restoring from asound.state

On ostree-based disros asound.state cannot be installed into /var
directory. Instead, this config installs into /usr/lib/alsa.

Support restoring vendor-specific sound configuration from
/usr/lib/alsa/asound.state if /var/lib/alsa/asound.state is
unavailable.

Upstream-Status: Pending
Signed-off-by: Oleksandr Suvorov <oleksandr.suvorov@foundries.io>
Signed-off-by: Jose Quaresma <jose.quaresma@foundries.io>
---
 alsactl/90-alsa-restore.rules.in | 3 +++
 alsactl/Makefile.am              | 1 +
 configure.ac                     | 6 ++++++
 3 files changed, 10 insertions(+)

diff --git a/alsactl/90-alsa-restore.rules.in b/alsactl/90-alsa-restore.rules.in
index 5db6080..c4b9564 100644
--- a/alsactl/90-alsa-restore.rules.in
+++ b/alsactl/90-alsa-restore.rules.in
@@ -24,6 +24,9 @@ IMPORT{program}="/usr/bin/cat /run/udev/alsa-hda-analog-card"
 ENV{ALSA_CARD_HDA_ANALOG}!="", ENV{ALSA_CARD_NUMBER}="$env{ALSA_CARD_HDA_ANALOG}"
 
 LABEL="alsa_restore_std"
+
+TEST!="@asoundrcfile@", TEST=="@daemonswitch@", RUN+="@sbindir@/alsactl@args@ -f @initasoundrcfile@ nrestore $devnode", GOTO="alsa_restore_end"
+TEST!="@asoundrcfile@", TEST!="@daemonswitch@", RUN+="@sbindir@/alsactl@args@ -f @initasoundrcfile@ restore $devnode", GOTO="alsa_restore_end"
 TEST!="@daemonswitch@", RUN+="@sbindir@/alsactl@args@ restore $env{ALSA_CARD_NUMBER}"
 TEST=="@daemonswitch@", RUN+="@sbindir@/alsactl@args@ nrestore $env{ALSA_CARD_NUMBER}"
 
diff --git a/alsactl/Makefile.am b/alsactl/Makefile.am
index e771717..8e529de 100644
--- a/alsactl/Makefile.am
+++ b/alsactl/Makefile.am
@@ -51,6 +51,7 @@ edit = \
 		  -e 's,@asoundrcfile\@,$(ASOUND_STATE_DIR)/asound.state,g' \
 		  -e "s;@extratest\@;$${extratest};g" \
 		  -e "s;@args\@;$${args};g" \
+		  -e 's,@initasoundrcfile\@,$(INIT_ASOUND_STATE_DIR)/asound.state,g' \
 							< $< > $@ || rm $@
 
 alsa-state.service: alsa-state.service.in
diff --git a/configure.ac b/configure.ac
index 5624add..463a1ea 100644
--- a/configure.ac
+++ b/configure.ac
@@ -428,6 +428,12 @@ AC_ARG_WITH([asound-state-dir],
         [ASOUND_STATE_DIR="/var/lib/alsa"])
 AC_SUBST(ASOUND_STATE_DIR)
 
+AC_ARG_WITH([init-asound-state-dir],
+        AS_HELP_STRING([--with-init-asound-state-dir=DIR], [Directory to place asound.state file in]),
+        [INIT_ASOUND_STATE_DIR="$withval"],
+        [INIT_ASOUND_STATE_DIR="/usr/lib/alsa"])
+AC_SUBST(INIT_ASOUND_STATE_DIR)
+
 AC_ARG_WITH([alsactl-lock-dir],
         AS_HELP_STRING([--with-alsactl-lock-dir=DIR], [Directory to place lock files in]),
         [ASOUND_LOCK_DIR="$withval"],
-- 
2.49.0

